How-to: Add a customized post-processor
====================================

We provide the ability to process output files by adding a customized post-processor.
In DocFX, the index file for full-text-search is generated by one post-processor named `ExtractSearchIndex`.
In this topic, we will show how to add a customized post-processor.

## Step 0: Preparation

* Create a new C# class library project in Visual Studio.
* Add nuget packages:
    * [`System.Collections.Immutable`](https://www.nuget.org/packages/System.Collections.Immutable/1.3.1) with version 1.3.1
    * [`Microsoft.Composition`](https://www.nuget.org/packages/Microsoft.Composition/1.0.31) with version 1.0.31
* Add `Microsoft.DocAsCode.Plugins`
If you are building DocFX from source code, add this reference to the project;
otherwise, add the nuget package `Microsoft.DocAsCode.Plugins` with the same version as DocFX.

## Step 1: Create a new class (MyProcessor.cs) with the following code:

```csharp
[Export(nameof(MyProcessor), typeof(IPostProcessor))]
public class MyProcessor : IPostProcessor
{
    // TODO: implements IPostProcessor
}
```

## Step 2: Update global metadata

```csharp
public ImmutableDictionary<string, object> PrepareMetadata(ImmutableDictionary<string, object> metadata)
{
    // TODO: add/remove/update property from global metadata
    return metadata;
}
```

In this method, we can update the global metadata before building all the files declared in `docfx.json`. If you don't need to change global metadata, you can just return the `metadata` input.

Example: The `ExtractSearchIndex` post-processor adds `"_enableSearch": true` to global metadata. The default template would then know it should load a search box in the navbar.

## Step 3: Process all the files generated by DocFX

```csharp
    public Manifest Process(Manifest manifest, string outputFolder)
    {
        // TODO: add/remove/update all the files included in manifest
        return manifest;
    }
```

The input for the method `manifest` contains a list of all files to process, and `outputFolder` specifies the output folder where our static website will be placed. We can implement customized operations here to process all files generated by DocFX.

> [!Note]
> Post-processors are meant to process the output files, so the `FileModel` can't be accessed in this phase. If you need such metadata here, one option is to save it in `FileModel.ManifestProperties` in the build phase, then access it through `ManifestItem.Metadata`. Another option is to save it somewhere in the output files, such as via HTML's `<meta>` tag.

Using `ExtractSearchIndex` for example again, we traverse all HTML files, extract key words from these HTML files and save a file named `index.json` under the `outputFolder`. Finally we return the unmodified manifest.

## Step 4: Build your project and copy the output DLL files to:

* Global: the folder with name `Plugins` under DocFX.exe
* Non-global: the folder with name `Plugins` under a template folder, then run `DocFX build` command with parameter `-t {template}`.

    *Hint*: DocFX can merge templates, so we can specify multiple template folders as `DocFX build -t {templateForRender},{templateForPlugins}`. Each of the template folders should have a subfolder named `Plugins` with exported assemblies.

## Step 5: Add your post processor in `docfx.json`

In this step, we need to enable the processor by adding its name in `docfx.json`. Here is an example:

```json
{
  "build": {
    ...
    "postProcessors": ["OutputPDF", "BeautifyHTML", "OutputPDF"]
  }
}
```

As you can see, the `postProcessors` property is an array, which means it can have multiple processors. The processors are run in the order given in the array.
In the above example, DocFX will run `OutputPDF` first, then `BeautifyHTML`, and then `OutputPDF` again.

If you want to enable the post-processors without changing `docfx.json`, you can use the build command option like `docfx build --postProcessors=OutputPDF,BeautifyHTML,OutputPDF`.

Note: The build command option `postProcessors` would override the corresponding configuration in `docfx.json`.
